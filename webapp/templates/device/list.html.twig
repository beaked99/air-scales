{# templates/device/list.html.twig #}
{% extends 'base_app.html.twig' %}

{% block title %}Devices{% endblock %}
{% block header_page_title %}Devices{% endblock %}

{% block app_header_subtitle %}
  <div class="text-sm text-gray-400 mt-1">Manage your AirScale devices</div>
{% endblock %}

{% block app_header_actions %}
  <button id="disconnect-btn" onclick="disconnectAndWait()" class="px-4 py-2 text-sm font-semibold bg-red-600 hover:bg-red-700 rounded-lg transition-colors" style="display: none;">
    <i class="fas fa-unlink mr-1"></i> Disconnect
  </button>
  <button id="scan-btn" onclick="openScanModal()" class="px-4 py-2 text-sm font-semibold bg-sky-600 hover:bg-sky-700 rounded-lg transition-colors">
    <i class="fas fa-bluetooth-b mr-1"></i> Scan
  </button>
{% endblock %}

{% block body %}

    <!-- Search/Filter Bar -->
    <section class="m-4">
      <div class="relative">
        <input type="text"
               id="search-input"
               placeholder="Search devices by MAC address..."
               class="w-full px-4 py-3 pl-10 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:border-sky-400">
        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
      </div>

      <!-- Filter Buttons -->
      <div class="flex gap-2 mt-3 overflow-x-auto">
        <button onclick="filterDevices('all')" class="filter-btn active px-3 py-1 text-sm bg-gray-700 hover:bg-gray-600 rounded-lg whitespace-nowrap" data-filter="all">
          All Devices
        </button>
        <button onclick="filterDevices('online')" class="filter-btn px-3 py-1 text-sm bg-gray-700 hover:bg-gray-600 rounded-lg whitespace-nowrap" data-filter="online">
          üü¢ Online
        </button>
        <button onclick="filterDevices('offline')" class="filter-btn px-3 py-1 text-sm bg-gray-700 hover:bg-gray-600 rounded-lg whitespace-nowrap" data-filter="offline">
          ‚ö™ Offline
        </button>
      </div>

      <!-- Auto-Switching Toggle (BLE Only) -->
      <div id="auto-switch-section" class="mt-4 p-3 bg-gray-800 border border-gray-700 rounded-lg" style="display: none;">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <i class="fas fa-exchange-alt text-sky-400"></i>
              <span class="font-medium text-white">Auto-Switch to Stronger Signal</span>
            </div>
            <p class="text-xs text-gray-400 mt-1">Automatically switch to devices with 20+ dBm better signal every 60s</p>
          </div>
          <label class="relative inline-flex items-center cursor-pointer ml-3">
            <input type="checkbox" id="auto-switch-toggle" class="sr-only peer" onchange="toggleAutoSwitch(this.checked)">
            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-sky-500 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-sky-600"></div>
          </label>
        </div>
      </div>
    </section>

    <!-- Connected Devices (Live via BLE) -->
    <section id="connected-devices-section" class="m-4" style="display: none;">
      <h2 class="text-lg font-semibold mb-3 text-green-400">üì± Connected Devices</h2>
      <div id="connected-devices-list" class="space-y-2">
        <!-- Populated by JavaScript -->
      </div>
    </section>

    <!-- All Devices -->
    <section class="m-4">
      <h2 class="text-lg font-semibold mb-3">üìã All Devices ({{ devices|length }})</h2>

      {% if devices|length == 0 %}
        <div class="p-8 text-center bg-gray-800 rounded-lg border border-gray-700">
          <i class="fas fa-inbox text-4xl text-gray-500 mb-3"></i>
          <p class="text-gray-400 mb-4">No devices registered yet</p>
          <button onclick="openScanModal()" class="px-4 py-2 bg-sky-600 hover:bg-sky-700 rounded-lg transition-colors">
            <i class="fas fa-bluetooth-b mr-2"></i>Scan for Devices
          </button>
        </div>
      {% else %}
        <div id="device-list" class="space-y-2">
          {% for device in devices %}
            <div class="device-card p-3 bg-gray-800 rounded-lg border border-gray-700 transition-all"
                 data-device-id="{{ device.id }}"
                 data-mac="{{ device.macAddress|upper }}"
                 data-status="{{ device.connectionStatus }}">
              <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="status-dot w-2 h-2 rounded-full {{ device.connectionStatus == 'connected' ? 'bg-green-400 animate-pulse' : 'bg-gray-500' }}"></span>
                    <a href="{{ path('device_detail', {id: device.id}) }}" class="font-medium text-white hover:text-sky-400 truncate">
                      {{ device.serialNumber ?: 'AS25-' ~ device.id }}
                    </a>
                  </div>
                  <div class="text-xs text-gray-400">
                    {% if device.macAddress %}
                      {{ device.macAddress|upper }}
                    {% else %}
                      <span class="text-yellow-500">No MAC address</span>
                    {% endif %}
                  </div>
                  <div class="text-xs text-gray-500 mt-1">
                    {{ device.lastSeenText }}
                    {% if device.deviceChannels|length > 0 %}
                      ‚Ä¢ {{ device.deviceChannels|length }} channel{{ device.deviceChannels|length > 1 ? 's' : '' }}
                    {% endif %}
                  </div>
                </div>
                <div class="flex gap-2 flex-shrink-0">
                  {% if device.macAddress %}
                    <button onclick="connectToDevice('{{ device.macAddress|upper }}', '{{ device.serialNumber ?: 'AS25-' ~ device.id }}')"
                            class="px-3 py-2 text-sm bg-sky-600 hover:bg-sky-700 rounded-lg"
                            title="Connect to device">
                      <i class="fas fa-bluetooth"></i>
                    </button>
                  {% endif %}
                  <a href="{{ path('device_detail', {id: device.id}) }}"
                     class="px-3 py-2 text-sm bg-gray-700 hover:bg-gray-600 rounded-lg"
                     title="View details">
                    <i class="fas fa-eye"></i>
                  </a>
                  <button onclick="forgetDevice({{ device.id }})"
                          class="px-3 py-2 text-sm bg-red-600 hover:bg-red-700 rounded-lg"
                          title="Forget device">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </section>

  </main>

  <!-- BLE Scan Modal -->
  <div id="scan-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-gray-800 rounded-lg border border-gray-700 w-full max-w-md">
      <div class="flex items-center justify-between p-4 border-b border-gray-700">
        <h3 class="text-lg font-semibold">Scan for Devices</h3>
        <button onclick="closeScanModal()" class="text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="p-4">
        <div id="scanning-status" class="text-center py-8 hidden">
          <i class="fas fa-spinner fa-spin text-4xl text-sky-400 mb-3"></i>
          <p class="text-gray-300">Scanning for nearby devices...</p>
        </div>

        <div id="discovered-devices" class="space-y-2 max-h-96 overflow-y-auto">
          <!-- Populated by JavaScript -->
        </div>

        <div id="no-devices-found" class="text-center py-8 text-gray-400 hidden">
          <i class="fas fa-signal text-2xl mb-2"></i>
          <p>No devices found</p>
          <p class="text-sm mt-1">Make sure your AirScale is powered on</p>
        </div>
      </div>

      <div class="p-4 border-t border-gray-700 flex gap-2">
        <button onclick="startScan()" class="flex-1 px-4 py-2 bg-sky-600 hover:bg-sky-700 rounded-lg">
          <i class="fas fa-redo mr-2"></i>Scan Again
        </button>
        <button onclick="closeScanModal()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg">
          Close
        </button>
      </div>
    </div>
  </div>

<script>
// Search and filter functionality
const searchInput = document.getElementById('search-input');
const deviceCards = document.querySelectorAll('.device-card');

searchInput.addEventListener('input', () => {
  const query = searchInput.value.toLowerCase();
  deviceCards.forEach(card => {
    const mac = card.getAttribute('data-mac').toLowerCase();
    const serial = card.querySelector('.font-medium').textContent.toLowerCase();
    if (mac.includes(query) || serial.includes(query)) {
      card.style.display = '';
    } else {
      card.style.display = 'none';
    }
  });
});

function filterDevices(filter) {
  // Update active button
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.remove('active', 'bg-sky-600');
    btn.classList.add('bg-gray-700');
  });
  event.target.classList.add('active', 'bg-sky-600');
  event.target.classList.remove('bg-gray-700');

  // Filter devices
  deviceCards.forEach(card => {
    const status = card.getAttribute('data-status');
    if (filter === 'all') {
      card.style.display = '';
    } else if (filter === 'online' && status === 'connected') {
      card.style.display = '';
    } else if (filter === 'offline' && status !== 'connected') {
      card.style.display = '';
    } else {
      card.style.display = 'none';
    }
  });
}

// BLE Scanning
function openScanModal() {
  document.getElementById('scan-modal').classList.remove('hidden');
  startScan();
}

function closeScanModal() {
  document.getElementById('scan-modal').classList.add('hidden');

  // Resume auto-discovery when closing scan modal
  if (window.AirScalesBLE && window.AirScalesBLE.resumeAutoDiscovery) {
    window.AirScalesBLE.resumeAutoDiscovery();
  }
}

let scanDevices = new Map(); // Store discovered devices
let isScanningActive = false;

async function startScan() {
  const scanningStatus = document.getElementById('scanning-status');
  const discoveredDevices = document.getElementById('discovered-devices');
  const noDevicesFound = document.getElementById('no-devices-found');

  scanningStatus.classList.remove('hidden');
  discoveredDevices.innerHTML = '';
  noDevicesFound.classList.add('hidden');
  scanDevices.clear();
  isScanningActive = true;

  if (!window.AirScalesBLE || !window.AirScalesBLE.isAvailable()) {
    discoveredDevices.innerHTML = '<div class="p-4 text-center text-yellow-400">BLE not available. Please use the mobile app.</div>';
    scanningStatus.classList.add('hidden');
    return;
  }

  try {
    // Start background scan (like nRF Connect - no popup!)
    await window.AirScalesBLE.scanForDevices(
      (deviceInfo) => {
        // Callback for each discovered device
        scanDevices.set(deviceInfo.wifiMac, deviceInfo);
        updateDiscoveredDevicesList();
      },
      10000 // Scan for 10 seconds
    );

    // After scan completes
    setTimeout(() => {
      isScanningActive = false;
      scanningStatus.classList.add('hidden');

      if (scanDevices.size === 0) {
        noDevicesFound.classList.remove('hidden');
      }
    }, 10000);

  } catch (error) {
    console.error('Scan failed:', error);
    isScanningActive = false;
    scanningStatus.classList.add('hidden');
    discoveredDevices.innerHTML = '<div class="p-4 text-center text-red-400">Scan failed. Please check Bluetooth permissions.</div>';
  }
}

function updateDiscoveredDevicesList() {
  const discoveredDevices = document.getElementById('discovered-devices');

  // Sort by RSSI (strongest signal first)
  const sortedDevices = Array.from(scanDevices.values()).sort((a, b) => b.rssi - a.rssi);

  let html = '';
  for (const device of sortedDevices) {
    const signalStrength = getSignalStrength(device.rssi);
    html += `
      <div class="p-3 bg-gray-700 hover:bg-gray-600 rounded-lg border border-gray-600 transition-colors cursor-pointer"
           onclick="connectToScannedDevice('${device.deviceId}', '${escapeHtml(device.name)}', '${device.wifiMac}')">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <div class="font-medium text-white">${escapeHtml(device.name)}</div>
            <div class="text-xs text-gray-400 mt-1">${device.wifiMac}</div>
          </div>
          <div class="text-right">
            <div class="text-sm ${signalStrength.color}">${signalStrength.icon} ${device.rssi} dBm</div>
            <div class="text-xs text-gray-400 mt-1">${signalStrength.label}</div>
          </div>
        </div>
      </div>
    `;
  }

  discoveredDevices.innerHTML = html;
}

function getSignalStrength(rssi) {
  if (rssi >= -60) {
    return { icon: 'üì∂', label: 'Excellent', color: 'text-green-400' };
  } else if (rssi >= -70) {
    return { icon: 'üì∂', label: 'Good', color: 'text-sky-400' };
  } else if (rssi >= -80) {
    return { icon: 'üì∂', label: 'Fair', color: 'text-yellow-400' };
  } else {
    return { icon: 'üì∂', label: 'Weak', color: 'text-red-400' };
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

async function connectToScannedDevice(deviceId, deviceName, wifiMac) {
  const discoveredDevices = document.getElementById('discovered-devices');

  try {
    discoveredDevices.innerHTML = `
      <div class="p-4 text-center">
        <i class="fas fa-spinner fa-spin text-3xl text-sky-400 mb-2"></i>
        <p class="text-gray-300">Connecting to ${deviceName}...</p>
      </div>
    `;

    await window.AirScalesBLE.connectById(deviceId, deviceName, wifiMac);

    discoveredDevices.innerHTML = `
      <div class="p-3 bg-green-900/20 border border-green-600 rounded-lg">
        <div class="flex items-center gap-2">
          <i class="fas fa-check-circle text-green-400"></i>
          <span class="text-green-100">Connected to ${deviceName}</span>
        </div>
      </div>
    `;

    setTimeout(() => {
      window.location.reload();
    }, 1500);

  } catch (error) {
    console.error('Connection failed:', error);
    discoveredDevices.innerHTML = `
      <div class="p-3 bg-red-900/20 border border-red-600 rounded-lg">
        <div class="text-red-100">Connection failed: ${error.message}</div>
      </div>
    `;

    setTimeout(() => {
      updateDiscoveredDevicesList();
    }, 3000);
  }
}

// Connect to a known device by MAC address
async function connectToDevice(macAddress, deviceName) {
  if (!window.AirScalesBLE || !window.AirScalesBLE.isAvailable()) {
    alert('Bluetooth not available. Please use the mobile app.');
    return;
  }

  // Show loading toast
  const toast = document.createElement('div');
  toast.className = 'fixed top-4 right-4 bg-sky-600 text-white px-4 py-3 rounded-lg shadow-lg z-50';
  toast.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Scanning for ' + deviceName + '...';
  document.body.appendChild(toast);

  try {
    // Start a scan to find this specific device
    let foundDevice = null;

    await window.AirScalesBLE.scanForDevices(
      (deviceInfo) => {
        if (deviceInfo.wifiMac === macAddress) {
          foundDevice = deviceInfo;
        }
      },
      5000 // Scan for 5 seconds
    );

    // Wait for scan to complete
    await new Promise(resolve => setTimeout(resolve, 5000));

    if (foundDevice) {
      toast.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Connecting...';
      await window.AirScalesBLE.connectById(foundDevice.deviceId, foundDevice.name, foundDevice.wifiMac);

      toast.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-3 rounded-lg shadow-lg z-50';
      toast.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Connected to ' + deviceName;
      setTimeout(() => {
        toast.remove();
        window.location.reload();
      }, 1500);
    } else {
      toast.className = 'fixed top-4 right-4 bg-yellow-600 text-white px-4 py-3 rounded-lg shadow-lg z-50';
      toast.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Device not found. Make sure it\'s powered on.';
      setTimeout(() => toast.remove(), 3000);
    }
  } catch (error) {
    console.error('Connection error:', error);
    toast.className = 'fixed top-4 right-4 bg-red-600 text-white px-4 py-3 rounded-lg shadow-lg z-50';
    toast.innerHTML = '<i class="fas fa-times-circle mr-2"></i>Connection failed';
    setTimeout(() => toast.remove(), 3000);
  }
}

// Forget device
function forgetDevice(deviceId) {
  if (!confirm('Are you sure you want to forget this device? This will remove your access and calibration data.')) {
    return;
  }

  fetch(`/device/${deviceId}/forget`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Remove card from view
      const card = document.querySelector(`[data-device-id="${deviceId}"]`);
      if (card) {
        card.style.transition = 'opacity 0.3s';
        card.style.opacity = '0';
        setTimeout(() => card.remove(), 300);
      }

      // Show success message
      const msg = document.createElement('div');
      msg.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
      msg.textContent = '‚úì Device forgotten';
      document.body.appendChild(msg);
      setTimeout(() => msg.remove(), 2000);
    } else {
      alert(data.error || 'Failed to forget device');
    }
  })
  .catch(err => {
    console.error('Error:', err);
    alert('Failed to forget device');
  });
}

// Disconnect and wait for slave devices to start advertising
async function disconnectAndWait() {
  const disconnectBtn = document.getElementById('disconnect-btn');

  if (!window.AirScalesBLE || !window.AirScalesBLE.isConnected()) {
    alert('No device connected');
    return;
  }

  try {
    // Pause auto-discovery so it doesn't reconnect
    window.AirScalesBLE.autoDiscoveryPaused = true;
    console.log('‚è∏Ô∏è Auto-discovery paused during disconnect wait period');

    // Show countdown
    let countdown = 30;
    disconnectBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-1"></i> Disconnecting... ${countdown}s`;
    disconnectBtn.disabled = true;

    // Disconnect
    await window.AirScalesBLE.disconnect();

    // Wait 30 seconds for slave devices to realize hub is gone and start advertising
    const interval = setInterval(() => {
      countdown--;
      disconnectBtn.innerHTML = `<i class="fas fa-hourglass-half mr-1"></i> Waiting for devices... ${countdown}s`;

      if (countdown <= 0) {
        clearInterval(interval);
        disconnectBtn.innerHTML = '<i class="fas fa-unlink mr-1"></i> Disconnect';
        disconnectBtn.disabled = false;
        disconnectBtn.style.display = 'none';

        // Show toast
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-3 rounded-lg shadow-lg z-50';
        toast.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Devices should now be advertising. Try scanning!';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);

        // Auto-discovery remains paused - will resume when user connects or closes scan modal
        console.log('‚úÖ Disconnect wait complete - auto-discovery still paused, ready for manual scan');
      }
    }, 1000);

  } catch (error) {
    console.error('Disconnect error:', error);
    disconnectBtn.innerHTML = '<i class="fas fa-unlink mr-1"></i> Disconnect';
    disconnectBtn.disabled = false;

    // Resume auto-discovery on error
    if (window.AirScalesBLE) {
      window.AirScalesBLE.autoDiscoveryPaused = false;
      console.log('‚ñ∂Ô∏è Auto-discovery resumed after disconnect error');
    }
  }
}

// Auto-switching toggle
function toggleAutoSwitch(enabled) {
  if (window.AirScalesBLE && window.AirScalesBLE.setAutoSwitch) {
    window.AirScalesBLE.setAutoSwitch(enabled);

    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 bg-sky-600 text-white px-4 py-3 rounded-lg shadow-lg z-50';
    toast.innerHTML = `<i class="fas fa-${enabled ? 'check-circle' : 'times-circle'} mr-2"></i>Auto-switching ${enabled ? 'enabled' : 'disabled'}`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
  }
}

// Initialize auto-switch toggle state
async function initAutoSwitchToggle() {
  console.log('üîç initAutoSwitchToggle() called');
  const autoSwitchSection = document.getElementById('auto-switch-section');
  const autoSwitchToggle = document.getElementById('auto-switch-toggle');

  console.log('üîç Elements found:', {
    section: !!autoSwitchSection,
    toggle: !!autoSwitchToggle
  });
  console.log('üîç window.AirScalesBLE exists:', !!window.AirScalesBLE);

  if (window.AirScalesBLE) {
    console.log('üîç Checking AirScalesBLE.isAvailable()...');
    const isAvail = window.AirScalesBLE.isAvailable();
    console.log('üîç AirScalesBLE.isAvailable():', isAvail);

    if (isAvail) {
      autoSwitchSection.style.display = 'block';
      console.log('‚úÖ Toggle section displayed (changed to block)');

      // Set initial toggle state from saved preference (async)
      const enabled = await window.AirScalesBLE.getAutoSwitchEnabled();
      console.log('‚úÖ Auto-switch enabled state:', enabled);
      autoSwitchToggle.checked = enabled;
    } else {
      console.warn('‚ö†Ô∏è AirScalesBLE.isAvailable() returned false - not on native platform');
    }
  } else {
    console.warn('‚ö†Ô∏è window.AirScalesBLE not defined');
  }
}

// Listen for BLE connections
function initializeBLEListeners() {
  console.log('üîç initializeBLEListeners called, window.AirScalesBLE:', !!window.AirScalesBLE);

  if (!window.AirScalesBLE) {
    console.log('‚è≥ window.AirScalesBLE not available yet, will retry in 100ms');
    setTimeout(initializeBLEListeners, 100);
    return;
  }

  console.log('‚úÖ window.AirScalesBLE available, setting up listeners');

  // Initialize auto-switch toggle when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(initAutoSwitchToggle, 500);
    });
  } else {
    // DOM already loaded
    setTimeout(initAutoSwitchToggle, 500);
  }

  // Check initial connection state
  if (window.AirScalesBLE.isConnected()) {
    document.getElementById('disconnect-btn').style.display = 'block';
    document.getElementById('connected-devices-section').style.display = 'block';
  }

  window.AirScalesBLE.addListener((event, data) => {
    if (event === 'connected') {
      // Show disconnect button
      document.getElementById('disconnect-btn').style.display = 'block';

      // Show connected device in special section
      const section = document.getElementById('connected-devices-section');
      const list = document.getElementById('connected-devices-list');
      section.style.display = 'block';

      list.innerHTML = `
        <div class="p-3 bg-green-900/20 border border-green-600 rounded-lg">
          <div class="flex items-center gap-2">
            <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
            <span class="text-green-100 font-medium">${data.deviceName || 'AirScale Device'}</span>
          </div>
          <div class="text-xs text-green-300 mt-1">Live connection active ‚Ä¢ Slave devices won't advertise</div>
        </div>
      `;
    } else if (event === 'disconnected') {
      // Hide disconnect button
      document.getElementById('disconnect-btn').style.display = 'none';
      document.getElementById('connected-devices-section').style.display = 'none';
    }
  });
}

// Start initialization when script loads
initializeBLEListeners();
</script>
{% endblock %}
