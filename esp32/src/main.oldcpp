/**
 * ESP32 HTTPS PWA Server with Access Point
 * Creates "AirScales-[MAC]" WiFi network and serves PWA over HTTPS
 */

#include <WiFi.h>
#include <HTTPSServer.hpp>
#include <SSLCert.hpp>
#include <HTTPRequest.hpp>
#include <HTTPResponse.hpp>
#include "server_cert_der.h"
#include "server_key_der.h"

// Include the certificate data generated by create_cert.sh
//#include "cert.h"
//#include "private_key.h"
#include <cstring>   // for strlen

using namespace httpsserver;

// Create SSL certificate object
SSLCert cert(
  server_cert_der, server_cert_der_len,
  server_key_der,  server_key_der_len
);


// Create HTTPS server
HTTPSServer secureServer = HTTPSServer(&cert, 443);

// PWA HTML content
const char* indexHtml = R"HTML(
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirScales PWA</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2196F3">
</head>
<body>
    <h1>Hello from AirScales!</h1>
    <p>This is a Progressive Web App served over HTTPS from your ESP32.</p>
    <p>PWA Status: <span id="status">Loading...</span></p>
    <p>Device: <span id="device">Loading...</span></p>
    
    <button onclick="testAPI()">Test API</button>
    <button onclick="getDeviceInfo()">Get Device Info</button>
    
    <div id="response"></div>
    
    <script>
        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('SW registered: ', registration);
                    document.getElementById('status').textContent = 'PWA Ready';
                })
                .catch(registrationError => {
                    console.log('SW registration failed: ', registrationError);
                    document.getElementById('status').textContent = 'PWA Failed';
                });
        } else {
            document.getElementById('status').textContent = 'Not Supported';
        }
        
        // Load device info on page load
        window.onload = function() {
            getDeviceInfo();
        };
        
        function testAPI() {
            fetch('/api/test')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('response').innerHTML = '<p><strong>API Response:</strong> ' + data + '</p>';
                })
                .catch(error => {
                    document.getElementById('response').innerHTML = '<p><strong>Error:</strong> ' + error + '</p>';
                });
        }
        
        function getDeviceInfo() {
            fetch('/api/device')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('device').textContent = data.name;
                    document.getElementById('response').innerHTML = 
                        '<p><strong>Device Info:</strong></p>' +
                        '<ul>' +
                        '<li>Name: ' + data.name + '</li>' +
                        '<li>MAC: ' + data.mac + '</li>' +
                        '<li>IP: ' + data.ip + '</li>' +
                        '<li>Uptime: ' + data.uptime + 's</li>' +
                        '</ul>';
                })
                .catch(error => {
                    document.getElementById('response').innerHTML = '<p><strong>Error:</strong> ' + error + '</p>';
                });
        }
    </script>
</body>
</html>
)HTML";

// Service Worker for offline functionality
const char* serviceWorker = R"SW(
const CACHE_NAME = 'airscales-pwa-v1';
const urlsToCache = [
    '/',
    '/manifest.json',
    '/api/device'
];

self.addEventListener('install', event => {
    console.log('Service Worker installing');
    event.waitUntil(
        caches.open(CACHE_NAME)
            .then(cache => {
                console.log('Caching app shell');
                return cache.addAll(urlsToCache);
            })
    );
});

self.addEventListener('fetch', event => {
    event.respondWith(
        caches.match(event.request)
            .then(response => {
                // Return cached version or fetch from network
                if (response) {
                    console.log('Serving from cache:', event.request.url);
                    return response;
                }
                console.log('Fetching from network:', event.request.url);
                return fetch(event.request);
            })
    );
});
)SW";

// Web App Manifest
const char* manifest = R"MNF(
{
    "name": "AirScales PWA",
    "short_name": "AirScales",
    "description": "Progressive Web App for AirScales device",
    "start_url": "/",
    "display": "standalone",
    "background_color": "#ffffff",
    "theme_color": "#2196F3",
    "orientation": "portrait",
    "icons": [
        {
            "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiBmaWxsPSIjMjE5NkYzIi8+Cjx0ZXh0IHg9Ijk2IiB5PSIxMDAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LXNpemU9IjMyIj5BUzwvdGV4dD4KPC9zdmc+",
            "sizes": "192x192",
            "type": "image/svg+xml"
        },
        {
            "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiBmaWxsPSIjMjE5NkYzIi8+Cjx0ZXh0IHg9IjI1NiIgeT0iMjgwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSI4MCI+QVM8L3RleHQ+Cjwvc3ZnPg==",
            "sizes": "512x512",
            "type": "image/svg+xml"
        }
    ]
}
)MNF";

// Handler functions
void handleRoot(HTTPRequest * req, HTTPResponse * res) {
    res->setHeader("Content-Type", "text/html");
    res->print(indexHtml);
}

void handleServiceWorker(HTTPRequest * req, HTTPResponse * res) {
    res->setHeader("Content-Type", "application/javascript");
    res->print(serviceWorker);
}

void handleManifest(HTTPRequest * req, HTTPResponse * res) {
    res->setHeader("Content-Type", "application/manifest+json");
    res->print(manifest);
}

void handleApiTest(HTTPRequest * req, HTTPResponse * res) {
    res->setHeader("Content-Type", "text/plain");
    res->print("Hello from AirScales HTTPS API! Secure connection established.");
}

void handleApiDevice(HTTPRequest * req, HTTPResponse * res) {
    String macAddress = WiFi.macAddress();
    macAddress.replace(":", "");
    String deviceName = "AirScales-" + macAddress;
    
    String jsonResponse = "{";
    jsonResponse += "\"name\":\"" + deviceName + "\",";
    jsonResponse += "\"mac\":\"" + WiFi.macAddress() + "\",";
    jsonResponse += "\"ip\":\"" + WiFi.softAPIP().toString() + "\",";
    jsonResponse += "\"uptime\":" + String(millis() / 1000);
    jsonResponse += "}";
    
    res->setHeader("Content-Type", "application/json");
    res->print(jsonResponse);
}

void handle404(HTTPRequest * req, HTTPResponse * res) {
    req->discardRequestBody();
    res->setStatusCode(404);
    res->setStatusText("Not Found");
    res->setHeader("Content-Type", "text/html");
    res->print("<!DOCTYPE html><html><head><title>Not Found</title></head>");
    res->print("<body><h1>404 Not Found</h1><p>The requested resource was not found.</p></body></html>");
}

void setup() {
    Serial.begin(115200);
    delay(1000);
    
    // Get MAC address and create unique AP name
    String macAddress = WiFi.macAddress();
    macAddress.replace(":", "");
    String apName = "AirScales-" + macAddress;
    
    Serial.println("========================================");
    Serial.println("       AirScales HTTPS PWA Server      ");
    Serial.println("========================================");
    
    // Create Access Point
    Serial.println("Creating Access Point...");
    Serial.print("AP Name: ");
    Serial.println(apName);
    
    WiFi.softAP(apName.c_str());
    
    Serial.println("Access Point created successfully!");
    Serial.print("AP IP address: ");
    Serial.println(WiFi.softAPIP());
    Serial.print("AP MAC address: ");
    Serial.println(WiFi.softAPmacAddress());
    
    // Create resource nodes for routing
    ResourceNode * nodeRoot = new ResourceNode("/", "GET", &handleRoot);
    ResourceNode * nodeServiceWorker = new ResourceNode("/sw.js", "GET", &handleServiceWorker);
    ResourceNode * nodeManifest = new ResourceNode("/manifest.json", "GET", &handleManifest);
    ResourceNode * nodeApiTest = new ResourceNode("/api/test", "GET", &handleApiTest);
    ResourceNode * nodeApiDevice = new ResourceNode("/api/device", "GET", &handleApiDevice);
    ResourceNode * node404 = new ResourceNode("", "GET", &handle404);
    
    // Register nodes with server
    secureServer.registerNode(nodeRoot);
    secureServer.registerNode(nodeServiceWorker);
    secureServer.registerNode(nodeManifest);
    secureServer.registerNode(nodeApiTest);
    secureServer.registerNode(nodeApiDevice);
    secureServer.setDefaultNode(node404);
    
    // Start HTTPS server
    Serial.println("Starting HTTPS server...");
    secureServer.start();
    
    if (secureServer.isRunning()) {
        Serial.println("HTTPS server started successfully!");
        Serial.println("========================================");
        Serial.println("To connect:");
        Serial.println("1. Connect to WiFi: " + apName);
        Serial.println("2. Visit: https://" + WiFi.softAPIP().toString());
        Serial.println("3. Accept security warning (self-signed cert)");
        Serial.println("4. Install PWA when prompted");
        Serial.println("========================================");
    } else {
        Serial.println("HTTPS server failed to start!");
    }
}

void loop() {
    // Handle HTTPS requests
    secureServer.loop();
    delay(1);
}